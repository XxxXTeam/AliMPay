<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="æ”¯ä»˜å®æ‰«ç æ”¯ä»˜">
    <meta name="theme-color" content="#1677ff">
    <title>æ‰«ç æ”¯ä»˜ - AliMPay</title>
    <link rel="stylesheet" href="/static/css/payment.css">
    <link rel="stylesheet" href="/static/css/animations.css">
</head>
<body>
    <!-- é¡µé¢åŠ è½½åŠ¨ç”» -->
    <div class="loading-overlay" id="pageLoader">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">æ­£åœ¨åŠ è½½æ”¯ä»˜é¡µé¢...</div>
        </div>
    </div>
    <div class="payment-container">
        <!-- Header -->
        <div class="payment-header">
            <div class="logo">ğŸ’°</div>
            <h1>æ”¯ä»˜å®æ‰«ç æ”¯ä»˜</h1>
            <p>è¯·ä½¿ç”¨æ”¯ä»˜å®APPæ‰«æä¸‹æ–¹äºŒç»´ç å®Œæˆæ”¯ä»˜</p>
        </div>

        <!-- Body -->
        <div class="payment-body">
            <!-- Order Information -->
            <div class="order-info">
                <div class="order-info-row">
                    <span class="order-info-label">è®¢å•å·</span>
                    <span class="order-info-value"><code>{{.order.trade_no}}</code></span>
                </div>
                <div class="order-info-row">
                    <span class="order-info-label">å•†å“åç§°</span>
                    <span class="order-info-value">{{.order.name}}</span>
                </div>
                <div class="order-info-row">
                    <span class="order-info-label">è®¢å•é‡‘é¢</span>
                    <span class="order-info-value">Â¥{{.order.amount}}</span>
                </div>
                <div class="order-info-row">
                    <span class="order-info-label">åº”ä»˜é‡‘é¢</span>
                    <span class="order-info-value amount">Â¥{{.order.payment_amount}}</span>
                </div>
                <div class="order-info-row">
                    <span class="order-info-label">åˆ›å»ºæ—¶é—´</span>
                    <span class="order-info-value">{{.order.create_time}}</span>
                </div>
            </div>

            <!-- QR Code Section -->
            <div class="qrcode-section">
                <div class="qrcode-wrapper">
                    <img src="{{.qr_code_data}}" alt="æ”¯ä»˜äºŒç»´ç " id="paymentQRCode">
                </div>

                {{if .qr_code_id}}
                <!-- Mobile Alipay Launch Button -->
                <div class="mobile-pay-section">
                    <button class="alipay-launch-btn" id="alipayLaunchBtn" onclick="launchAlipay()">
                        <svg class="alipay-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                            <path d="M1024 701.9v202.8c0 66.6-53.9 120.4-120.4 120.4H120.4C53.9 1025.1 0 971.3 0 904.7V120.4C0 53.9 53.9 0 120.4 0h783.1c66.6 0 120.4 53.9 120.4 120.4V701.9z" fill="#00A0E9"/>
                            <path d="M928.9 735.7c-99.7-47.4-244.8-110.9-325.6-146.5 21.9-36.3 39.3-75.8 51.6-117.6H546v-64.3h199.4v-38.7H546v-96.8h-38.7c0 0 0 0 0 0H444.2v96.8H244.8v38.7h199.4v64.3H335.3c-32.3 116.5-103.9 217.4-203.5 289.2 51.6 39.3 122.5 72.6 171.1 90.6 90.6-77.4 154.8-184.5 184.5-315.5h258.1c-19.4 64.3-45.2 125.8-77.4 181.3 38.7 16.1 141.9 58.1 225.8 96.8V735.7z" fill="#FFFFFF"/>
                        </svg>
                        <span>æ‰‹æœºç«¯æ‹‰èµ·æ”¯ä»˜å®</span>
                    </button>
                    <p class="mobile-pay-tip">é€‚ç”¨äºæ‰‹æœºæµè§ˆå™¨ï¼Œç‚¹å‡»ç›´æ¥æ‰“å¼€æ”¯ä»˜å®APP</p>
                </div>
                {{end}}

                <div class="qrcode-tips">
                    <div class="tip-icon">ğŸ’¡</div>
                    <p><strong>æ”¯ä»˜æç¤ºï¼š</strong></p>
                    <p>è¯·åŠ¡å¿…æ”¯ä»˜å‡†ç¡®é‡‘é¢ï¼š<strong style="color: #ff4d4f;">Â¥{{.order.payment_amount}}</strong></p>
                    <p>æ”¯ä»˜æ—¶æ— éœ€å¡«å†™å¤‡æ³¨ä¿¡æ¯</p>
                </div>
            </div>

            <!-- Instructions -->
            <div class="instructions">
                <h3>
                    <span>ğŸ“‹</span>
                    <span>æ”¯ä»˜æ­¥éª¤</span>
                </h3>
                <div class="instruction-step">
                    <div class="step-number">1</div>
                    <div class="step-text">æ‰“å¼€æ”¯ä»˜å®APPï¼Œç‚¹å‡»é¦–é¡µã€Œæ‰«ä¸€æ‰«ã€</div>
                </div>
                <div class="instruction-step">
                    <div class="step-number">2</div>
                    <div class="step-text">æ‰«æä¸Šæ–¹äºŒç»´ç ï¼Œè¾“å…¥é‡‘é¢ <strong>Â¥{{.order.payment_amount}}</strong></div>
                </div>
                <div class="instruction-step">
                    <div class="step-number">3</div>
                    <div class="step-text">ç¡®è®¤æ”¯ä»˜åï¼Œé¡µé¢å°†è‡ªåŠ¨è·³è½¬</div>
                </div>
            </div>

            <!-- Status Section -->
            <div class="status-section">
                <div class="status-indicator checking" id="statusIndicator">
                    <span class="status-text">æ­£åœ¨æ£€æµ‹æ”¯ä»˜çŠ¶æ€...</span>
                </div>
                <div class="countdown">
                    è¯·åœ¨ <span class="countdown-time" id="countdownTime">5:00</span> å†…å®Œæˆæ”¯ä»˜
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="payment-footer">
            <p>æ”¯ä»˜é‡åˆ°é—®é¢˜ï¼Ÿ<a href="javascript:void(0)" onclick="contactSupport()">è”ç³»å®¢æœ</a></p>
            <p style="margin-top: 8px; color: #00000040;">Powered by AliMPay Â· å®‰å…¨æ”¯ä»˜ä¿éšœ</p>
        </div>
    </div>

    <!-- Hidden data for JavaScript -->
    <div style="display: none;">
        <div data-pid="{{.order.pid}}"></div>
        <div data-qrcode-id="{{.qr_code_id}}"></div>
        <div data-amount="{{.order.payment_amount}}"></div>
        <div data-trade-no="{{.order.trade_no}}"></div>
    </div>

    <!-- ============================================ -->
    <!-- æ‰€æœ‰åŠŸèƒ½å®Œå…¨å†…è”ï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨JSæ–‡ä»¶ -->
    <!-- ============================================ -->
    <script>
        (function() {
            'use strict';

            // ========================================
            // 1. å¢å¼ºçš„è®¾å¤‡æ£€æµ‹å™¨ï¼ˆå®Œå…¨å†…è”ï¼Œå¤šé‡åˆ¤æ–­ï¼‰
            // ========================================
            const DeviceDetector = {
                getUserAgent() {
                    return navigator.userAgent || '';
                },
                
                // åŸºäºUAçš„ç§»åŠ¨è®¾å¤‡æ£€æµ‹ï¼ˆå¢å¼ºç‰ˆï¼‰
                isMobileUA() {
                    const ua = this.getUserAgent();
                    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|Tablet|tablet/i.test(ua);
                },
                
                // åŸºäºå±å¹•å°ºå¯¸åˆ¤æ–­
                isMobileScreen() {
                    return window.innerWidth <= 768 || window.screen.width <= 768;
                },
                
                // è§¦æ‘¸å±æ£€æµ‹
                isTouchScreen() {
                    return ('ontouchstart' in window) || 
                           (navigator.maxTouchPoints > 0) || 
                           (navigator.msMaxTouchPoints > 0);
                },
                
                // ç»¼åˆåˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡ï¼ˆå¤šé‡æ¡ä»¶ï¼‰
                isMobile() {
                    // åªè¦æ»¡è¶³ä»»æ„ä¸€ä¸ªæ¡ä»¶å°±è®¤ä¸ºæ˜¯ç§»åŠ¨è®¾å¤‡
                    const isUA = this.isMobileUA();
                    const isScreen = this.isMobileScreen();
                    const isTouch = this.isTouchScreen();
                    
                    console.log('[DeviceDetector] UAæ£€æµ‹:', isUA);
                    console.log('[DeviceDetector] å±å¹•æ£€æµ‹:', isScreen);
                    console.log('[DeviceDetector] è§¦æ‘¸æ£€æµ‹:', isTouch);
                    
                    // åªè¦æœ‰ä¸€ä¸ªæ¡ä»¶æ»¡è¶³å°±è®¤ä¸ºæ˜¯ç§»åŠ¨è®¾å¤‡
                    return isUA || (isScreen && isTouch);
                },
                
                isWeChat() {
                    return /MicroMessenger/i.test(this.getUserAgent());
                },
                
                isAlipay() {
                    return /AlipayClient/i.test(this.getUserAgent());
                },
                
                getDeviceType() {
                    if (this.isWeChat()) return 'wechat';
                    if (this.isAlipay()) return 'alipay';
                    if (this.isMobile()) return 'mobile';
                    return 'desktop';
                }
            };

            // æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.DeviceDetector = DeviceDetector;

            console.log('[AliMPay] Device Type:', DeviceDetector.getDeviceType());
            console.log('[AliMPay] User Agent:', DeviceDetector.getUserAgent().substring(0, 50) + '...');

            // ========================================
            // 2. Toastæç¤ºï¼ˆå®Œå…¨å†…è”ï¼‰
            // ========================================
            window.showToast = function(message, type = 'info', duration = 2000) {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                    padding: 12px 24px; border-radius: 8px; color: white; font-size: 14px;
                    z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    animation: slideDown 0.3s ease;
                `;
                
                const colors = { success: '#52c41a', error: '#ff4d4f', warning: '#faad14', info: '#1890ff' };
                toast.style.background = colors[type] || colors.info;
                
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            };

            // ========================================
            // 3. è¾…åŠ©åŠŸèƒ½
            // ========================================
            window.contactSupport = function() {
                alert('å¦‚éœ€å¸®åŠ©ï¼Œè¯·è”ç³»å•†æˆ·å®¢æœ\n\nè®¢å•å·ï¼š{{.order.trade_no}}');
            };

            // ç§»é™¤é¡µé¢åŠ è½½åŠ¨ç”»
            window.addEventListener('DOMContentLoaded', function() {
                const pageLoader = document.getElementById('pageLoader');
                if (pageLoader) {
                    setTimeout(() => {
                        pageLoader.classList.add('fade-out');
                        setTimeout(() => pageLoader.remove(), 300);
                    }, 500);
                }
            });

        })(); // ç«‹å³æ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰åŠŸèƒ½å¯ç”¨

        /**
         * æ‹‰èµ·æ”¯ä»˜å®APP
         * @description åœ¨ç§»åŠ¨ç«¯è°ƒç”¨æ”¯ä»˜å®URL Schemeæ‹‰èµ·APP
         */
        function launchAlipay() {
            // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            if (!DeviceDetector.isMobile()) {
                showToast('è¯·ä½¿ç”¨æ‰‹æœºæ‰«æäºŒç»´ç æ”¯ä»˜', 'warning');
                return;
            }

            const qrCodeId = document.querySelector('[data-qrcode-id]').getAttribute('data-qrcode-id');
            const amount = document.querySelector('[data-amount]').getAttribute('data-amount');
            const tradeNo = document.querySelector('[data-trade-no]').getAttribute('data-trade-no');

            if (!qrCodeId) {
                showToast('ç³»ç»Ÿé…ç½®é”™è¯¯ï¼šç¼ºå°‘æ”¶æ¬¾ç ID', 'error');
                return;
            }

            // å¾®ä¿¡å†…æç¤º
            if (DeviceDetector.isWeChat()) {
                showToast('è¯·ç‚¹å‡»å³ä¸Šè§’ï¼Œé€‰æ‹©"åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€"', 'info', 3000);
                return;
            }

            // æ„å»ºæ”¯ä»˜å®URL Schemeï¼ˆä½¿ç”¨æ­£ç¡®çš„æ ¼å¼ï¼‰
            // å®Œæ•´çš„æ”¯ä»˜å®äºŒç»´ç URLï¼ŒåŒ…å«é‡‘é¢å’Œå¤‡æ³¨
            const fullQrCodeUrl = `https://qr.alipay.com/${qrCodeId}?amount=${amount}&remark=${tradeNo}`;
            
            // æ”¯ä»˜å®URL Scheme - ä½¿ç”¨saId=10000007æ‰“å¼€è½¬è´¦é¡µé¢
            const scheme = `alipays://platformapi/startapp?saId=10000007&qrcode=${encodeURIComponent(fullQrCodeUrl)}`;

            console.log('[Alipay] QR Code ID:', qrCodeId);
            console.log('[Alipay] Amount:', amount);
            console.log('[Alipay] Trade No:', tradeNo);
            console.log('[Alipay] Scheme URL:', scheme);
            
            showToast('æ­£åœ¨æ‰“å¼€æ”¯ä»˜å®...', 'success');

            // å°è¯•æ‹‰èµ·æ”¯ä»˜å®
            window.location.href = scheme;
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœ3ç§’åè¿˜åœ¨é¡µé¢ï¼Œè¯´æ˜æ‹‰èµ·å¤±è´¥ï¼Œæç¤ºç”¨æˆ·
            setTimeout(() => {
                if (document.hasFocus()) {
                    console.log('[Alipay] Launch may have failed, showing fallback message');
                    showToast('å¦‚æœªæ‰“å¼€æ”¯ä»˜å®ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€APPæ‰«ç ', 'warning', 3000);
                }
            }, 2000);
        }

        // showToastå·²åœ¨ä¸Šæ–¹å…¨å±€å®šä¹‰ï¼Œè¿™é‡Œåˆ é™¤é‡å¤å®šä¹‰

        /**
         * åˆå§‹åŒ–é¡µé¢
         * @description é¡µé¢åŠ è½½æ—¶æ‰§è¡Œçš„åˆå§‹åŒ–é€»è¾‘ï¼ˆDeviceDetectorå·²å†…è”ï¼Œç«‹å³å¯ç”¨ï¼‰
         */
        function initPage() {
            const deviceType = DeviceDetector.getDeviceType();
            const launchBtn = document.getElementById('alipayLaunchBtn');
            
            console.log('[Page] Initializing...');
            console.log('[Device] Type:', deviceType);
            console.log('[Device] isMobile:', DeviceDetector.isMobile());
            console.log('[Device] isWeChat:', DeviceDetector.isWeChat());

            if (launchBtn) {
                if (DeviceDetector.isMobile()) {
                    // ç§»åŠ¨ç«¯æ˜¾ç¤ºæŒ‰é’®
                    launchBtn.parentElement.style.display = 'block';
                    
                    // å¾®ä¿¡ä¸­ä¿®æ”¹æŒ‰é’®æ–‡å­—
                    if (DeviceDetector.isWeChat()) {
                        launchBtn.innerHTML = `
                            <svg class="alipay-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                                <path d="M1024 701.9v202.8c0 66.6-53.9 120.4-120.4 120.4H120.4C53.9 1025.1 0 971.3 0 904.7V120.4C0 53.9 53.9 0 120.4 0h783.1c66.6 0 120.4 53.9 120.4 120.4V701.9z" fill="#00A0E9"/>
                                <path d="M928.9 735.7c-99.7-47.4-244.8-110.9-325.6-146.5 21.9-36.3 39.3-75.8 51.6-117.6H546v-64.3h199.4v-38.7H546v-96.8h-38.7c0 0 0 0 0 0H444.2v96.8H244.8v38.7h199.4v64.3H335.3c-32.3 116.5-103.9 217.4-203.5 289.2 51.6 39.3 122.5 72.6 171.1 90.6 90.6-77.4 154.8-184.5 184.5-315.5h258.1c-19.4 64.3-45.2 125.8-77.4 181.3 38.7 16.1 141.9 58.1 225.8 96.8V735.7z" fill="#FFFFFF"/>
                            </svg>
                            <span>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€</span>
                        `;
                    }
                } else {
                    // PCç«¯æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    launchBtn.parentElement.innerHTML = `
                        <div class="pc-scan-tip">
                            <div style="font-size: 16px; margin-bottom: 8px;">ğŸ’» ç”µè„‘ç«¯è®¿é—®</div>
                            <div style="font-size: 14px; color: #00000073;">
                                è¯·ä½¿ç”¨æ‰‹æœºæ‰«æä¸Šæ–¹äºŒç»´ç å®Œæˆæ”¯ä»˜
                            </div>
                        </div>
                    `;
                }
            }

            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideDown {
                    from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
                    to { transform: translateX(-50%) translateY(0); opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateX(-50%) translateY(0); opacity: 1; }
                    to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
                }
                .pc-scan-tip {
                    text-align: center;
                    padding: 20px;
                    background: #f5f5f5;
                    border-radius: 12px;
                    color: #000000d9;
                }
            `;
            document.head.appendChild(style);

            // ========================================
            // 4. WebSocketå®æ—¶è®¢å•çŠ¶æ€ç›‘å¬ï¼ˆå®Œå…¨å†…è”ï¼‰
            // ========================================
            const tradeNo = document.querySelector('[data-trade-no]').getAttribute('data-trade-no');
            if (tradeNo) {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsURL = `${protocol}//${window.location.host}/ws/order?order_id=${tradeNo}`;
                
                console.log('[WebSocket] Connecting to:', wsURL);
                
                try {
                    const ws = new WebSocket(wsURL);
                    
                    ws.onopen = function() {
                        console.log('[WebSocket] Connected');
                    };
                    
                    ws.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('[WebSocket] Message:', data);
                            
                            if (data.type === 'status_update' && data.status === 1) {
                                // è®¢å•å·²æ”¯ä»˜
                                showToast('æ”¯ä»˜æˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            }
                        } catch (e) {
                            console.error('[WebSocket] Parse error:', e);
                        }
                    };
                    
                    ws.onerror = function(error) {
                        console.error('[WebSocket] Error:', error);
                    };
                    
                    ws.onclose = function() {
                        console.log('[WebSocket] Disconnected');
                    };
                } catch (e) {
                    console.error('[WebSocket] Connection failed:', e);
                }
            }
        }

        // ç¡®ä¿DOMå’Œè„šæœ¬éƒ½åŠ è½½å®Œæˆåå†åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPage);
        } else {
            initPage();
        }
    </script>
</body>
</html>

